# パフォーマンス調査結果

## 問題点の特定

### 1. **重いDOM操作の頻繁な実行**

#### `getBoundingClientRect()`の呼び出し
- **場所**: `updateModalPositionsIfNeeded()` (line 626)
- **問題**: カメラ位置が変わるたびに呼ばれる（モーダルが開いている間）
- **影響**: レイアウト再計算を強制し、非常に重い操作
- **頻度**: カメラが動くたび（プレイヤー移動時）

#### `querySelector`の多用
- **場所**: 各スロット更新関数内で多数使用
- **問題**: DOM検索が毎回実行される（キャッシュされていない）
- **影響**: 大量のDOM走査が発生
- **頻度**: スロット更新のたび

### 2. **DOM再構築の非効率**

#### `innerHTML = ''`による完全再構築
- **場所**: `updateShopContent()` (line 2094)
- **問題**: ショップコンテンツ全体を削除して再構築
- **影響**: イベントリスナーの再登録、DOM再描画が発生
- **頻度**: ショップタブ切り替え、購入時など

### 3. **CSS transition/filterの負荷**

#### `transition: all 0.2s`
- **場所**: `.inventory-slot`, `.book-slot` (style.css line 130, 295)
- **問題**: すべてのプロパティ変更にアニメーションが適用される
- **影響**: GPU負荷が高い

#### `filter: drop-shadow`
- **場所**: スロットのホバー/選択状態 (style.css line 131, 136, 296, 301)
- **問題**: フィルター効果はGPU負荷が高い
- **影響**: 特に複数のスロットで同時に適用されると重い

### 4. **不要な更新処理**

#### モーダルが開いている間のカメラ追従
- **場所**: `updateUIPositions()` → `updateModalPositionsIfNeeded()`
- **問題**: モーダルが開いている間もカメラ位置変更を監視
- **影響**: モーダルは固定位置なので不要な更新

#### Canvas描画の最適化不足
- **場所**: `updateInventorySlots()`, `updateBookSlots()`
- **問題**: データ属性チェックはあるが、`querySelector`が毎回呼ばれる
- **影響**: DOM検索のオーバーヘッド

## 最適化の提案

### 優先度: 高

1. **`getBoundingClientRect()`の呼び出しを削減**
   - モーダルが開いている間は位置更新を停止
   - リサイズ時のみ更新

2. **`querySelector`の結果をキャッシュ**
   - スロット要素の参照を事前に取得して保持
   - 更新時はキャッシュされた参照を使用

3. **`innerHTML`の使用を避ける**
   - 既存のDOM要素を再利用
   - 差分更新のみ実行

### 優先度: 中

4. **CSS transition/filterの最適化**
   - `transition: all` → 特定のプロパティのみ指定
   - `filter`の使用を最小限に

5. **モーダル表示時のゲームループ最適化**
   - モーダルが開いている間はゲーム更新をスキップ
   - 必要な処理のみ実行

### 優先度: 低

6. **Canvas描画のさらなる最適化**
   - 画像キャッシュの活用
   - 描画が必要な時のみ実行
